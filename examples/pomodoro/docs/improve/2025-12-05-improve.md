# Improve: Pomodoro demo — Readability & Small Refactors (2025-12-05)

## 1. Assessment
- **Constitution Alignment:** The demo mostly follows the project's constitution: small, local changes; single-binary intent; and test-focused development. Recent work preserved those constraints while adding a small UI improvement.
- **Design Alignment:** The code keeps a clear separation between domain (`internal/app`) and platform (`internal/tray`). The tray updater and app timer are separate responsibilities, but some lifecycle and naming choices have made the boundary less explicit (see Risks).
- **Quality:** Overall quality is good for a small demo: concise files, unit tests, and a mock-based test for tray interactions. Readability issues exist in a few helpers (ticker lifecycle, naming, and minimal documentation) that make the code slightly harder to reason about quickly.
- **Risks:**
  - Subtle lifecycle leaks if `OnStateChange` subscriptions are not unsubscribed.
  - Threading requirement for `systray` (main OS thread) is a potential source of runtime bugs if callers are unclear about where setters must run.
  - Small public API changes (like adding `Remaining()` to `App`) can ripple if the `App` interface is implemented elsewhere.

## 2. Lessons
- **Worked Well:**
  - Clear domain separation: `internal/app` handles timer state and durations; `internal/tray` handles presentation. (`internal/app/app.go`, `internal/tray/systray_impl.go`)
  - Testability by construction: `New(durations...)` enables short-duration tests; `MockTray` enables UI-path testing without a GUI. (`internal/app/app_test.go`, `internal/tray/mock.go`)
  - Small, incremental changes: the recent increment (show remaining time) was implemented as focused, testable edits.

- **To Improve:**
  - Helper and API naming can be clearer: `ManageTitleUpdates` is functional but would read better as a `TitleUpdater` type with `Run`/`Stop` methods. (`internal/tray/updater.go`)
  - Concurrency and lifecycle contracts are under-documented: `OnStateChange` subscription and systray-thread expectations need explicit comments. (`internal/app/app.go`, `internal/tray/systray_impl.go`)
  - Tests use small sleeps and implicit wiring in places; tests can be more deterministic and intention-revealing. (`internal/tray/updater_test.go`, `internal/app/remaining_test.go`)

- **Emerging Patterns:**
  - Dependency injection for time/ticker and setters is applied consistently to make logic testable (`updater.go` uses injected ticker factory and setter functions).
  - Prefer small helper structs over large function signatures for clarity — the code benefits from grouping related behaviors into types.

## 3. Improvements

#### Improvement 1: Document the `App` interface and timer contract
- **Lens:** Documentation / Naming
- **Priority:** H
- **Effort:** 20–30 min
- **Files:** `examples/pomodoro/internal/app/app.go`, `examples/pomodoro/internal/app/remaining_test.go`
- **Change:** Add a concise doc comment for the `App` interface explaining responsibilities and concurrency expectations (which methods are safe to call concurrently). Document `Remaining()` semantics (units, zero meaning) and add a field comment for `timerApp.end` describing how it is used.
- **Increment Hint (optional):** "Document timer domain API and concurrency contract"

#### Improvement 2: Refactor tray updater into a `TitleUpdater` type
- **Lens:** Naming / Modularity
- **Priority:** H
- **Effort:** 30–45 min
- **Files:** `examples/pomodoro/internal/tray/updater.go`, `examples/pomodoro/internal/tray/updater_test.go`, `examples/pomodoro/internal/tray/systray_impl.go`
- **Change:** Replace the single `ManageTitleUpdates` function with a small `TitleUpdater` struct that holds dependencies (`app.App`, setter functions, ticker factory). Provide methods `Run(ctx)` and `Stop()` so lifecycle is explicit. Add a top-level doc comment that explains thread expectations (title setters must be invoked from the systray thread or be thread-safe wrappers).
- **Increment Hint (optional):** "Refactor tray updater to TitleUpdater struct for readability and testability"

#### Improvement 3: Make `OnStateChange` unsubscribeable
- **Lens:** Modularity / Testing
- **Priority:** M
- **Effort:** 30–50 min
- **Files:** `examples/pomodoro/internal/app/app.go`, `examples/pomodoro/internal/tray/updater.go`
- **Change:** Change `OnStateChange(fn func(State))` to return an unsubscribe function (or add a new `SubscribeStateChange` that returns an unsubscribe). Use the unsubscribe in `TitleUpdater` to avoid leaks and make lifecycle explicit. Update tests accordingly.
- **Increment Hint (optional):** "Make OnStateChange return unsubscribe function"

#### Improvement 4: Document the systray main-thread requirement
- **Lens:** Documentation / Architecture
- **Priority:** H
- **Effort:** 10–15 min
- **Files:** `examples/pomodoro/internal/tray/systray_impl.go`, `examples/pomodoro/README.md`
- **Change:** Add a short comment in `systray_impl.go` and an entry in `README.md` that clarifies: all `systray` API calls must run on the OS main thread; provide the idiomatic pattern used in this demo (create setters inside `systray.Run` and pass them to helpers).
- **Increment Hint (optional):** "Document systray threading pattern"

#### Improvement 5: Use named constants for durations and intervals
- **Lens:** Naming / Simplicity
- **Priority:** M
- **Effort:** 10–15 min
- **Files:** `examples/pomodoro/internal/tray/updater.go`, `examples/pomodoro/internal/tray/systray_impl.go`, `examples/pomodoro/internal/app/app.go`
- **Change:** Introduce `const titleUpdateInterval = 10 * time.Second` and use it in the updater and wiring instead of inline `10*time.Second`. Consider exposing default durations (`25m`, `5m`) as named constants or documenting them in the `New()` constructor comment.
- **Increment Hint (optional):** "Use named constants for durations"

#### Improvement 6: Improve test determinism and naming
- **Lens:** Testing / Readability
- **Priority:** M
- **Effort:** 20–30 min
- **Files:** `examples/pomodoro/internal/tray/updater_test.go`, `examples/pomodoro/internal/app/remaining_test.go`
- **Change:** Rename tests to intention-revealing names (e.g., `TestTitleUpdater_UpdatesOnTick`, `TestApp_RemainingCountsDown`). Replace `Sleep`-based synchronizations with explicit channels or wait groups where possible. Add short comments in tests explaining why short durations are used.
- **Increment Hint (optional):** "Make tests clearer and more deterministic"

#### Improvement 7: Small hygiene pass — names and comments
- **Lens:** Naming / Duplication
- **Priority:** L
- **Effort:** 30–40 min
- **Files:** `examples/pomodoro/internal/tray/updater.go`, `examples/pomodoro/internal/app/app.go`, `examples/pomodoro/internal/tray/systray_impl.go`
- **Change:** Add doc comments on exported functions/types. Rename ambiguous variables (for example, `a` -> `appSvc`) for readability. Remove or refactor any unused helpers.
- **Increment Hint (optional):** "Naming and doc hygiene pass"

## 4. Risks and Coordination
- Breaking `OnStateChange` backwards-compatibility: prefer adding a new `Subscribe`-style function or keep the old API as a thin adapter for a short deprecation window.
- Systray thread-safety: emphasize documentation and tests that verify usage on the correct thread. Keep the setter wrapper pattern in `systray_impl.go` as canonical.
- PR strategy: implement changes in small PRs: (A) docs + constants + `App` doc changes + test renames; (B) `TitleUpdater` refactor + tests + wiring + README update.

If you want, I will now create the file in the repository (this file) — otherwise tell me to adjust priorities or proposed improvements.
